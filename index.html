<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
    		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">

		<title>Shared Things</title>
		<!-- JQuery etc... -->
       		<!-- <link href="jquery-ui-1.10.4.custom/css/smoothness/jquery-ui-1.10.4.custom.css" rel="stylesheet"> ignore jquery ui styles in favour of bootstrap --> 
		<script src="bootstrap/js/jquery.min.js"></script> 

        	<script src="jquery-ui-1.10.4.custom/js/jquery-ui-1.10.4.custom.js"></script> <!-- enough jquery ui for dragging  -->
		<script src="jquery.ui.touch-punch/jquery.ui.touch-punch.min.js"></script> <!-- http://touchpunch.furf.com/ so jquery dragging is touch enabled -->
    <script src="config.js" ></script>
  <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALKC1tljWTKklkQBusA89LXkcu5MxhW68&sensor=true">
    </script>
		<!-- Bootstrap -->
		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<!-- Include all compiled plugins (below), or include individual files as needed -->

    <link href="style.css" rel="stylesheet">
		<script>
			var world = {
              "x1":{"x":70,"y":112.5}, "x2":{"x":70,"y":112.5}, "x3":{"x":70,"y":112.5},
              "x4":{"x":70,"y":112.5}, "x5":{"x":70,"y":112.5}, "o1":{"x":70,"y":112.5},
              "o2":{"x":70,"y":112.5}, "o3":{"x":70,"y":112.5}, "o4":{"x":70,"y":112.5},
              "o5":{"x":70,"y":112.5}, "tttboard":{"x":70,"y":112.5}
            };

      function logDrag(event, ui){
        // get the current target from the world state
        var item =  event.target.id;

        //update current item's position in the world state
        world[item].x = ui.position.left;
        world[item].y = ui.position.top;
        
        // wrap the information for this move and send it to the server.
        var data = {"type":"move", "id":item, "x":world[item].x, "y":world[item].y};
        var positions = JSON.stringify(data);

        socket.send(positions);

      }

      var currentLocation ={};
      var map;
      function initialize(location) {
        var mapOptions = {
          center: location,
          zoom: 10
        };

        map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);

        var marker = new google.maps.Marker({
                position:location,
                title:"Player",
        });

        google.maps.event.addListener(marker,'click',function() {
          map.setZoom(16);
          map.setCenter(marker.getPosition());
          console.log(this.getTitle());
        });

        marker.setMap(map);

      }

      
      $(function() { 
        if ("geolocation" in navigator) {
            // if the device support the geolocation
            navigator.geolocation.getCurrentPosition(function(position) {
              currentLocation.lat = position.coords.latitude;
              currentLocation.lng = position.coords.longitude;
              console.log(currentLocation);
              initialize(currentLocation);
            });
        } else {
          /* geolocation IS NOT available */
          alert("no");
        }
        // shake to reset
        window.ondevicemotion = function(event) {
                var ax = Math.round(event.acceleration.x);
                var ay = Math.round(event.acceleration.y);
                var az = Math.round(event.acceleration.z);

                // if shake detected, reset the world
                var data = {"type":"reset"};
                if (Math.abs(ax)>50 || Math.abs(ay)>50 || Math.abs(az)>50) {
                  socket.send(JSON.stringify(data));
                }
            };

        socket = new WebSocket("ws://localhost:"+port);
        socket.onopen = function (event) {
          console.log("connected");
        };

        socket.onclose = function (event) {
          console.log("closed code:" + event.code + " reason:" +event.reason + " wasClean:"+event.wasClean);
        };
        
        socket.onmessage = function (event) {
          var move = JSON.parse(event.data);


          // if the data recieved is to initialize the game
          if (move.type=="initial") {
            console.log("initial!!!!!");
            world = JSON.parse(move.data);

            console.log(world);
            // reset all the position
            $("img").each(function() {
              $(this).css("left",world[$(this).attr("id")].x);
              $(this).css("top",world[$(this).attr("id")].y);
            });
          } else {
          // the data is just to change a specific position of an item
            world[move.id].x= move.x;
            world[move.id].y = move.y;

            // change the position of that item
            $("#"+move.id).css("left",world[move.id].x);
            $("#"+move.id).css("top",world[move.id].y);
          }
        };

        var height = $(window).height();
        $("#world").css('height', height);
        $("#map-canvas").css('height', height);
        
        $("#world img").draggable({ containment: $("#border") }); 
        $("#world img").on("dragstart", function(event, ui) { logDrag(event, ui); });
        $("#world img").on("dragstop" , function(event, ui) { logDrag(event, ui); });
        $("#world img").on("drag"     , function(event, ui) { logDrag(event, ui); });
      });
		</script>
	</head>

  <body style="padding-top:70px; padding-bottom:70px;" >
<!-- try {.navbar-fixed-top, .navbar-fixed-bottom, .navbar-static-top} X {.navbar-inverse }
     have to add padding-top:70px, or padding-bottom:70px for fixed navbar
-->
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">OXOX</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="active"><a href="#">Playing</a></li>
        <li><a href="#">Instructions</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Select a world<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a href="#" data-world='1'>Action</a></li>
            <li><a href="#" data-world='2'>Another action</a></li>
            <li><a href="#" data-world='3'>Something else here</a></li>
            <li><a href="#" data-world='4'>One more separated link</a></li>
          </ul>
        </li>
      </ul>
      <form class="navbar-form navbar-right">
        <div class="form-group">
          <input type="text" class="form-control" id="input-name" placeholder="Create a world">
        </div>
        <button type="submit" id="world-create" class="btn btn-default">Create</button>
      </form>

    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
	<div class="container">
		<div class="row">
			<div class="col-md-6" id="border">
				<div id="world" style="z-index:3;">
					<img id="x1" src="images/x.gif" style="z-index:2;" class="draggable" />
					<img id="x2" src="images/x.gif" style="z-index:2;" class="draggable" />
					<img id="x3" src="images/x.gif" style="z-index:2;" class="draggable" />
					<img id="x4" src="images/x.gif" style="z-index:2;" class="draggable" />
					<img id="x5" src="images/x.gif" style="z-index:2;" class="draggable" />
					<img id="o1" src="images/o.gif" style="z-index:2;" class="draggable" />
					<img id="o2" src="images/o.gif" style="z-index:2;" class="draggable" />
					<img id="o3" src="images/o.gif" style="z-index:2;" class="draggable" />
					<img id="o4" src="images/o.gif" style="z-index:2;" class="draggable" />
					<img id="o5" src="images/o.gif" style="z-index:2;" /class="draggable" >
					<img id="tttboard" src="images/tictactoe.gif" style="z-index:1;" class="draggable" />
				</div>
			</div>
      <div class="col-md-6">
      <div id="map-canvas">
        
      </div>
      </div>
		</div>
	</div>
		<!-- Bootstrap -->
		<script src="bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>

